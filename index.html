<html>
  <head>
    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
    <script>
      var CLARIFICATION_PENALTY=10;
      var names = [];
      var namesIndex=0;
      var mode = 0;
      var modesRun=0;
      var modes = ['stemming','jaro_winkler','phonetic'];
      var modeColors = ['#F5D6D6','#EBF5D6','#ADD6EB'];
      var t0;

      function init()
      {
        mode=1;
        userId=0;
        $('#controls').css({'background':modeColors[mode], 'padding':'50px', 'width':'66%'});
        $('#namesSelect').css({'width':'75%'});
        enableControls();
      }

      function keyup()
      {
        if($('#fninput').val() == 'First Name' ||
          $('#fninput').val() === '' ||
          $('#lninput').val() == 'Last Name' ||
          $('#lninput').val() === '')
        {
          $('#searchinput').attr('disabled', 'disabled');
        }
        else if($('#fninput').val() != 'fninput' &&
          $('#fninput').val() !== '' &&
          $('#lninput').val() != 'lninput' &&
          $('#lninput').val() !== '')
        {
          $("#searchinput").removeAttr('disabled');
        }
      }

      function focusFunction(input, value)
      {
        if(input.value==value){
          input.value='';
        }
      }

      function blurFunction(input, value)
      {
        if(input.value==='')
        {
          input.value = value;
        }
      }

      function getNames(callback)
      {
        $.get("https://localhost:9080/names", fillNames).error(ajaxError);

        function fillNames(data, status, jqXHR)
        {
          data.patients.every(
            function(x)
            {
              names.push(x);
              return true;
            }
          );

          callback();
        }
      }

      function notPresent()
      {
        var deltat=Date.now()-t0;

        var answer = {
                        mode:modes[mode],
                        observed:'notPresent',
                        actual:names[namesIndex]._id,
                        selected:'',
                        deltat:deltat,
                        userId:userId,
                        present:names[namesIndex].present,
                      };

        $.post('https://localhost:9080/answers', answer, posted('notPresent')).error(ajaxError);

        clearNames();
        changeFile();
      }

      function clarification()
      {
        disableControls();
        countdown(CLARIFICATION_PENALTY);
      }

      function countdown(x)
      {
        if(x>0)
        {
          $('#timerButton').attr('value',x);
          setTimeout(function(){countdown(x-1);}, 1000);
        }
        else
        {
          $('#timerButton').removeAttr('hidden');
          enableControls();

          var deltat = (Date.now()-t0)/1000;

          var answer = {
            mode:modes[mode],
            observed:'clarification',
            actual:names[namesIndex]._id,
            selected:'',
            deltat:deltat,
            userId:userId,
            present:names[namesIndex].present,
          };

          $.post('https://localhost:9080/answers', answer, posted('clarification')).error(ajaxError);
          clearNames();
          changeFile();
        }
      }

      function disableControls()
      {
        $('#fninput').attr('disabled','disabled');
        $('#lninput').attr('disabled','disabled');
        $('#searchinput').attr('disabled','disabled');
        $('#notPresentButton').attr('disabled','disabled');
        $('#selectedButton').attr('disabled','disabled');
        $('#clarificationButton').attr('disabled','disabled');
        $('clarificationButton').attr('disabled','disabled');
        $('#audioControls').removeAttr('controls');
        $('#timerButton').show();
      }

      function enableControls()
      {
        $('#fninput').removeAttr('disabled','disabled');
        $('#lninput').removeAttr('disabled','disabled');
        $('#searchinput').removeAttr('disabled','disabled');
        $('#notPresentButton').removeAttr('disabled','disabled');
        $('#selectedButton').removeAttr('disabled','disabled');
        $('#clarificationButton').removeAttr('disabled','disabled');
        $('clarificationButton').removeAttr('disabled','disabled');
        $('#audioControls').attr('controls','controls');
        $('#timerButton').hide();
      }

      function selected()
      {
        var selectedName = $('#namesSelect').find(':selected').val();

        if(!selectedName)
        {
          alert('no name selected');
          return;
        }

        var answer = {
          mode:modes[mode],
          observed:'selected',
          actual:names[namesIndex]._id,
          selected:selectedName,
          deltat:Date.now()-t0,
          userId:userId,
          present:names[namesIndex].present,
        };

        $.post('https://localhost:9080/answers', answer, posted('selected')).error(ajaxError);
        clearNames();
        changeFile();
      }

      function changeFile()
      {
        t0 = Date.now();
        namesIndex++;
        if(namesIndex >= names.length)
        {
          namesIndex=0;
          changeMode();
          return;
        }

        $('audioControls').attr('src',names[namesIndex].file);
      }

      function changeMode()
      {
        modesRun++;

        if(modesRun>=3)
        {
          alert('thank you for completing the study');
          disableControls();
          return;
        }

        mode=++mode%3;
        $('#controls').css({'background':modeColors[mode], 'padding':'50px', 'width':'66%'});
      }

      function search()
      {
        clearNames();

        var path='https://localhost:9080' +
          '/' + modes[mode] +
          '/' + $('#fninput').val() +
          '/' + $('#lninput').val();

        $.get(path, fillNames).error(ajaxError);

        function fillNames(data, status, jqXHR)
        {
          data.patients.every(
            function(x)
            {
              $('#namesSelect').append('<option value=' + x._id + '>' + x.first + ' ' + x.last + '</option>');
            }
          );
        }
      }

      function clearNames()
      {
        $('#namesSelect').find('option').remove();
      }

      function ajaxError(e)
      {
        console.log(e);
      }

      function posted(x)
      {
        console.log('posted:' + x);
      }
    </script>
  <head>
  <body onLoad="init();getNames(changeFile)">
    <div id='audioPlayerDiv'>
      <input id='timerButton' type="button" value='' disabled hidden/>
      <audio controls id='audioControls' src=''/>
    </div><br><br>
    <div id='controls'>
      <select id='namesSelect' multiple size='8'>
      </select><br>
      <input id='fninput' type='text' value='First Name' size='50' onkeyup='keyup();' onfocus='focusFunction(this, this.value);' onblur='blurFunction(this, "First Name")'/>
      <input id='lninput' type='text' value='Last Name' size='50' onkeyup='keyup();' onfocus='focusFunction(this, this.value);' onblur='blurFunction(this, "Last Name")'/>
      <input id='searchinput' type='button' value='Search' disabled onclick='search();'/><br><br>
      <input id='notPresentButton' type='button' value='not present' onclick='notPresent();'/>
      <input id='selectedButton' type='button' value='selected' onclick='selected();'/>
      <input id='clarificationButton' type='button' value='clarification' onclick='clarification();'/>
    </div>
  </body>
</html>
